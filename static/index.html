<!doctype html>

<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
	<title>Epidemic Go</title>
	<script src="//cdn.socket.io/socket.io-1.2.0.js"></script>
	<link href="//fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

	<!-- Custom CSS -->
	<link href="css/custom.css" rel="stylesheet">
	<!--Import Google Icon Font-->
	<link href="//fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!--Let browser know website is optimized for mobile-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css">

	<!--Import jQuery before materialize.js-->
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>

  <!-- Compiled and minified JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/js/materialize.min.js"></script>
</head>


<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
		<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

<!-- TODO: Include Map API (Probably Google Maps) -->
<style>
	#map {
		position: absolute;
		left: 0;
		top: 0;
		height: 100%;
		width: 100%;
		z-index: -1;
	}
</style>

</head>

<body>

	<!--Navbar & Sidebar-->
	<nav>
		<div class="nav-wrapper blue lighten-1">
			<a href="#" class="brand-logo center">Epidemic Go</a>
			<a href="#"><i class="material-icons right">perm_identity</i></a>
			<ul id="slide-out" class="side-nav">
				<li><a href="#!">Home</a></li>
				<li><a href="#!">Social</a></li>
			</ul>
			<a href="#" data-activates="slide-out" class="button-collapse"><i class="material-icons">menu</i></a>
		</div>
	</nav>
	<!--Navbar & Sidebar-->
	<div id="map"></div>
	<a class="btn-floating btn-large waves-effect waves-light blue lighten-1" id="Infect-button">Infect!</a>

	<script>
	const id = Math.random();
	const socket = io();
	const REFRESH_RATE = 1500;

	var map;
	var heatmap;
	var center = null;
	var markers = [];

	function getPosition(callback) {
	  setTimeout(function(){
	    getPosition(callback);
	  }, REFRESH_RATE);
	  if (navigator && navigator.geolocation && navigator.geolocation.getCurrentPosition) {
	    navigator.geolocation.getCurrentPosition(function(loc) {
	      callback({
	        lat: loc.coords.latitude,
	        lng: loc.coords.longitude
	      });
	    });
	  } else {
	    callback({
	      lat: 0,
	      lng: 0
	    });
	  }
	}

	function initMap() {
	  var uluru = {
	    lat: 32,
	    lng: -117
	  };
	  map = new google.maps.Map(document.getElementById('map'), {
	    zoom: 14,
	    center: uluru
	  });
	  if (center) {
	    map.setCenter(center);
	  }

	  getPosition(function(loc){
	    center = loc;
	    if (map) {
	      map.setCenter(loc);
	      socket.emit("joined", JSON.stringify(loc));
	    }
	  });
	}

	$(".button-collapse").sideNav();
	socket.on("update", function(evt) {
	  var locations = JSON.parse(evt);
	  if (map) {
	    markers.forEach(function(marker) {
	      marker.setMap(null);
	    });

	    heatmap = new google.maps.visualization.HeatmapLayer({
	      data: markers.map(function(marker){return marker.position;}),
	      map: map
	    });
	    markers = [];

	    locations.forEach(function(coords) {
	      markers.push(new google.maps.Marker({
	        position: coords,
	        map: null
	      }));
	    });
	  }
	});
	</script>

	<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBC75EnaIuHo--O2S_dMWNP7WEIsmGZjAg&libraries=visualization&callback=initMap">
	</script>
</body>

</html>
